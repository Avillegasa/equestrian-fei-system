services:
  # BACKEND - Django API + WebSockets
  - type: web
    name: equestrian-backend
    runtime: python
    region: oregon
    plan: free
    branch: main
    rootDir: equestrian-fei-system/backend
    buildCommand: chmod +x ../../build.sh && bash ../../build.sh
    startCommand: gunicorn config.wsgi:application --config gunicorn_config.py
    healthCheckPath: /api/health/

    envVars:
      - key: PYTHON_VERSION
        value: "3.11.0"

      - key: DJANGO_SETTINGS_MODULE
        value: config.settings

      - key: SECRET_KEY
        generateValue: true

      - key: DEBUG
        value: "False"

      - key: ALLOWED_HOSTS
        value: ".onrender.com,localhost,127.0.0.1"

      - key: DATABASE_URL
        fromDatabase:
          name: equestrian-db
          property: connectionString

      - key: CORS_ALLOWED_ORIGINS
        value: "https://equestrian-frontend.onrender.com,http://localhost:5173"

      - key: JWT_ACCESS_TOKEN_LIFETIME
        value: "3600"

      - key: JWT_REFRESH_TOKEN_LIFETIME
        value: "604800"

      - key: MONITORING_ENABLED
        value: "True"

    autoDeploy: true

  # FRONTEND - React/Vite SPA
  - type: web
    name: equestrian-frontend
    runtime: static
    branch: main
    rootDir: equestrian-fei-system/frontend
    buildCommand: npm install && npm run build
    staticPublishPath: dist

    headers:
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: X-XSS-Protection
        value: 1; mode=block

    routes:
      - type: rewrite
        source: /*
        destination: /index.html

    envVars:
      - key: VITE_API_BASE_URL
        value: "https://equestrian-backend.onrender.com/api"

      - key: VITE_WS_URL
        value: "wss://equestrian-backend.onrender.com"

    autoDeploy: true

databases:
  - name: equestrian-db
    databaseName: equestrian_fei_db
    region: oregon
    plan: free
