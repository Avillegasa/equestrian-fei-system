# üöÄ GU√çA COMPLETA DE DEPLOYMENT - RENDER.COM
## Sistema de Gesti√≥n Ecuestre FEI

---

## üìã TABLA DE CONTENIDOS

1. [Requisitos Previos](#requisitos-previos)
2. [Preparaci√≥n del Repositorio](#preparaci√≥n-del-repositorio)
3. [Configuraci√≥n en Render.com](#configuraci√≥n-en-rendercom)
4. [Deployment Paso a Paso](#deployment-paso-a-paso)
5. [Verificaci√≥n Post-Deployment](#verificaci√≥n-post-deployment)
6. [Troubleshooting](#troubleshooting)
7. [Upgrade a Plan Pagado](#upgrade-a-plan-pagado)
8. [Mantenimiento](#mantenimiento)

---

## üìå REQUISITOS PREVIOS

### ‚úÖ Checklist Pre-Deployment

- [ ] Cuenta en [GitHub](https://github.com)
- [ ] Cuenta en [Render.com](https://render.com) (gratis)
- [ ] Repositorio Git del proyecto
- [ ] C√≥digo subido a GitHub
- [ ] Estructura del proyecto: `equestrian-fei-system/` con carpetas `backend/` y `frontend/`

### üìÇ Estructura del Repositorio

```
tu-repositorio-github/
‚îú‚îÄ‚îÄ equestrian-fei-system/
‚îÇ   ‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ manage.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ gunicorn_config.py
‚îÇ   ‚îî‚îÄ‚îÄ frontend/
‚îÇ       ‚îú‚îÄ‚îÄ src/
‚îÇ       ‚îú‚îÄ‚îÄ package.json
‚îÇ       ‚îî‚îÄ‚îÄ vite.config.js
‚îú‚îÄ‚îÄ render.yaml
‚îú‚îÄ‚îÄ build.sh
‚îú‚îÄ‚îÄ .env.production.example
‚îî‚îÄ‚îÄ DEPLOYMENT_GUIDE.md
```

---

## üîß PREPARACI√ìN DEL REPOSITORIO

### 1. Verificar Archivos de Configuraci√≥n

Aseg√∫rate de que existen estos archivos en la ra√≠z del proyecto:

```bash
# En la ra√≠z del repositorio
ls -la
```

Debes ver:
- ‚úÖ `render.yaml` - Configuraci√≥n de servicios
- ‚úÖ `build.sh` - Script de build
- ‚úÖ `.env.production.example` - Variables de entorno de ejemplo
- ‚úÖ `equestrian-fei-system/backend/gunicorn_config.py` - Configuraci√≥n del servidor
- ‚úÖ `equestrian-fei-system/backend/requirements.txt` - Dependencias Python

### 2. Actualizar .gitignore

Aseg√∫rate de que `.gitignore` incluye:

```gitignore
# Environment variables
.env
.env.local
.env.production

# Python
*.pyc
__pycache__/
*.py[cod]
*$py.class
venv/
*.sqlite3

# Django
staticfiles/
media/
logs/
backups/

# Node
node_modules/
dist/
.DS_Store
```

### 3. Commit y Push a GitHub

```bash
# Aseg√∫rate de estar en la rama main
git branch

# Agregar todos los archivos nuevos
git add .

# Crear commit
git commit -m "Add Render.com deployment configuration"

# Push a GitHub
git push origin main
```

---

## üåê CONFIGURACI√ìN EN RENDER.COM

### Paso 1: Crear Cuenta en Render.com

1. Ve a [https://render.com](https://render.com)
2. Haz clic en **"Get Started for Free"**
3. Reg√≠strate con tu cuenta de GitHub (recomendado)
4. Autoriza a Render.com para acceder a tus repositorios

### Paso 2: Conectar Repositorio de GitHub

1. En el dashboard de Render.com, haz clic en **"New +"**
2. Selecciona **"Blueprint"** (para usar `render.yaml`)
3. Conecta tu repositorio de GitHub
4. Selecciona el repositorio del proyecto ecuestre

---

## üöÄ DEPLOYMENT PASO A PASO

### Opci√≥n A: Deployment Autom√°tico con Blueprint (RECOMENDADO)

#### 1. Usar render.yaml

Render.com detectar√° autom√°ticamente el archivo `render.yaml` en tu repositorio.

1. Haz clic en **"New +"** ‚Üí **"Blueprint"**
2. Selecciona tu repositorio
3. Render.com mostrar√° los servicios detectados:
   - ‚úÖ **equestrian-backend** (Web Service)
   - ‚úÖ **equestrian-frontend** (Static Site)
   - ‚úÖ **equestrian-db** (PostgreSQL)
   - ‚úÖ **equestrian-redis** (Redis)

4. Revisa la configuraci√≥n y haz clic en **"Apply"**

#### 2. Configurar Variables de Entorno

Render.com configurar√° autom√°ticamente la mayor√≠a de variables, pero verifica:

**Backend Service:**
- ‚úÖ `SECRET_KEY` - Generado autom√°ticamente
- ‚úÖ `DEBUG` - `False`
- ‚úÖ `ALLOWED_HOSTS` - `.onrender.com,localhost,127.0.0.1`
- ‚úÖ `DATABASE_URL` - Conectado autom√°ticamente
- ‚úÖ `REDIS_URL` - Conectado autom√°ticamente
- ‚ö†Ô∏è `CORS_ALLOWED_ORIGINS` - **DEBES ACTUALIZARLO**

**Frontend Service:**
- ‚ö†Ô∏è `VITE_API_URL` - **DEBES CONFIGURARLO**
- ‚ö†Ô∏è `VITE_WS_URL` - **DEBES CONFIGURARLO**

#### 3. Actualizar CORS (MUY IMPORTANTE)

Una vez que el frontend est√© desplegado, obtendr√°s una URL como:
```
https://equestrian-frontend.onrender.com
```

Actualiza la variable `CORS_ALLOWED_ORIGINS` en el backend:

1. Ve al servicio **equestrian-backend**
2. Click en **"Environment"**
3. Busca `CORS_ALLOWED_ORIGINS`
4. Actualiza a: `https://equestrian-frontend.onrender.com,http://localhost:5173`
5. Guarda cambios

#### 4. Actualizar URLs del Frontend

1. Ve al servicio **equestrian-frontend**
2. Click en **"Environment"**
3. Actualiza `VITE_API_URL` con la URL del backend:
   ```
   https://equestrian-backend.onrender.com
   ```
4. Actualiza `VITE_WS_URL`:
   ```
   wss://equestrian-backend.onrender.com
   ```
5. Guarda y espera a que se redespliegue

---

### Opci√≥n B: Deployment Manual (Alternativa)

Si prefieres crear los servicios manualmente:

#### 1. Crear PostgreSQL Database

1. Click **"New +"** ‚Üí **"PostgreSQL"**
2. Configuraci√≥n:
   - **Name:** `equestrian-db`
   - **Database:** `equestrian_fei_db`
   - **User:** `postgres` (autom√°tico)
   - **Region:** Oregon (o m√°s cercano)
   - **Plan:** Free

3. Click **"Create Database"**

#### 2. Crear Redis Instance

1. Click **"New +"** ‚Üí **"Redis"**
2. Configuraci√≥n:
   - **Name:** `equestrian-redis`
   - **Region:** Oregon (mismo que la DB)
   - **Plan:** Free
   - **Maxmemory Policy:** `allkeys-lru`

3. Click **"Create Redis"**

#### 3. Crear Backend Service

1. Click **"New +"** ‚Üí **"Web Service"**
2. Conecta tu repositorio de GitHub
3. Configuraci√≥n:
   - **Name:** `equestrian-backend`
   - **Region:** Oregon
   - **Branch:** main
   - **Root Directory:** `equestrian-fei-system/backend`
   - **Runtime:** Python 3
   - **Build Command:**
     ```bash
     chmod +x ../../build.sh && ../../build.sh
     ```
   - **Start Command:**
     ```bash
     gunicorn config.wsgi:application --config gunicorn_config.py
     ```
   - **Plan:** Free

4. **Environment Variables:**
   ```
   PYTHON_VERSION=3.11
   DEBUG=False
   ALLOWED_HOSTS=.onrender.com,localhost,127.0.0.1
   ```

5. **Advanced Settings:**
   - Health Check Path: `/api/health/`
   - Auto-Deploy: Yes

6. Click **"Create Web Service"**

#### 4. Conectar Database y Redis al Backend

1. En el servicio `equestrian-backend`, ve a **"Environment"**
2. Click **"Add Environment Variable"**
3. Agrega:
   - `DATABASE_URL`: Click "Add from Database" ‚Üí selecciona `equestrian-db`
   - `REDIS_URL`: Click "Add from Redis" ‚Üí selecciona `equestrian-redis`

#### 5. Crear Frontend Service

1. Click **"New +"** ‚Üí **"Static Site"**
2. Conecta tu repositorio
3. Configuraci√≥n:
   - **Name:** `equestrian-frontend`
   - **Branch:** main
   - **Root Directory:** `equestrian-fei-system/frontend`
   - **Build Command:**
     ```bash
     npm install && npm run build
     ```
   - **Publish Directory:** `dist`

4. **Environment Variables:**
   ```
   VITE_API_URL=https://equestrian-backend.onrender.com
   VITE_WS_URL=wss://equestrian-backend.onrender.com
   ```

5. Click **"Create Static Site"**

---

## ‚úÖ VERIFICACI√ìN POST-DEPLOYMENT

### 1. Verificar Backend

#### A. Health Check
```bash
curl https://equestrian-backend.onrender.com/api/health/
```

Respuesta esperada:
```json
{
  "status": "healthy",
  "message": "FEI Equestrian System API is running",
  "version": "1.0.0"
}
```

#### B. Verificar Database
En los logs del backend, busca:
```
‚úÖ Database migrations completed
‚úÖ Superuser 'admin' created
```

#### C. Verificar Redis
```
‚úÖ Using Redis from REDIS_URL for Channel Layers
```

#### D. Test Login API
```bash
curl -X POST https://equestrian-backend.onrender.com/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "admin123"}'
```

Respuesta esperada:
```json
{
  "access": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "user": {
    "id": 1,
    "username": "admin",
    "role": "admin",
    ...
  }
}
```

### 2. Verificar Frontend

1. Abre en el navegador:
   ```
   https://equestrian-frontend.onrender.com
   ```

2. Debes ver la p√°gina de login

3. Prueba login con:
   - **Usuario:** `admin`
   - **Password:** `admin123`

4. Verifica que:
   - ‚úÖ Login funciona
   - ‚úÖ Dashboard carga correctamente
   - ‚úÖ Navegaci√≥n entre p√°ginas funciona
   - ‚úÖ API calls funcionan (no hay errores CORS)

### 3. Verificar WebSockets (Rankings en tiempo real)

1. Login como admin
2. Ve a una competencia
3. Click en **"Rankings"**
4. Abre Developer Console (F12)
5. En la pesta√±a Network, busca conexiones WebSocket
6. Debes ver: `wss://equestrian-backend.onrender.com/ws/...` conectado

---

## üêõ TROUBLESHOOTING

### Problema 1: "Application failed to start"

**S√≠ntoma:** El backend no arranca

**Soluciones:**

1. **Verifica logs en Render.com:**
   - Ve al servicio backend
   - Click en "Logs"
   - Busca errores

2. **Errores comunes:**

   **Error: "No module named 'gunicorn'"**
   ```bash
   # Soluci√≥n: Aseg√∫rate de que requirements.txt incluye gunicorn
   # Debe estar en equestrian-fei-system/backend/requirements.txt
   gunicorn==21.2.0
   ```

   **Error: "relation does not exist"**
   ```bash
   # Soluci√≥n: Las migraciones no corrieron
   # Verifica que build.sh se ejecut√≥ correctamente
   # Manualmente, ejecuta:
   python manage.py migrate
   ```

   **Error: "SECRET_KEY not set"**
   ```bash
   # Soluci√≥n: Genera una nueva SECRET_KEY en Render.com
   # Environment ‚Üí SECRET_KEY ‚Üí Generate Value
   ```

### Problema 2: CORS Errors en Frontend

**S√≠ntoma:** Errores en consola del navegador tipo:
```
Access to XMLHttpRequest blocked by CORS policy
```

**Soluci√≥n:**

1. Verifica `CORS_ALLOWED_ORIGINS` en backend incluye la URL del frontend:
   ```
   https://equestrian-frontend.onrender.com
   ```

2. Verifica `VITE_API_URL` en frontend apunta al backend:
   ```
   https://equestrian-backend.onrender.com
   ```

3. **IMPORTANTE:** No incluir `/` al final de las URLs

### Problema 3: WebSockets No Conectan

**S√≠ntoma:** Rankings en tiempo real no actualizan

**Soluci√≥n:**

1. Verifica que Redis est√° corriendo:
   - Ve al servicio `equestrian-redis`
   - Debe estar "Available"

2. Verifica `REDIS_URL` en backend:
   - Environment ‚Üí REDIS_URL ‚Üí debe apuntar a tu Redis instance

3. Verifica `VITE_WS_URL` en frontend:
   ```
   wss://equestrian-backend.onrender.com
   ```

### Problema 4: Static Files No Cargan

**S√≠ntoma:** CSS/JS no cargan, p√°gina sin estilos

**Backend:**
```bash
# Verifica que collectstatic corri√≥
python manage.py collectstatic --no-input
```

**Frontend:**
```bash
# Verifica que build complet√≥
npm run build
# Debe crear carpeta dist/
```

### Problema 5: Database Connection Failed

**S√≠ntoma:** Error "could not connect to server"

**Soluci√≥n:**

1. Verifica que la database `equestrian-db` est√° "Available"
2. Verifica que `DATABASE_URL` est√° configurado en backend
3. Verifica que est√°n en la misma regi√≥n (Oregon)

### Problema 6: Service Dormido (Free Tier)

**S√≠ntoma:** Primera request tarda 30-60 segundos

**Explicaci√≥n:** Esto es normal en free tier. El servicio duerme tras 15 min de inactividad.

**Soluciones:**

1. **Keep-Alive Service** (Gratis):
   - Usa un servicio como [UptimeRobot](https://uptimerobot.com) (gratis)
   - Configura ping cada 14 minutos a `/api/health/`

2. **Upgrade a Starter Plan** ($7/mes):
   - Servicios nunca duermen
   - Mejor performance

---

## üí∞ UPGRADE A PLAN PAGADO

### Free Tier vs Starter Plan

| Feature | Free | Starter ($7/mes) |
|---------|------|------------------|
| **RAM** | 512MB | 512MB |
| **CPU** | Compartido | Compartido |
| **Dormido** | S√≠ (15 min) | No |
| **Build Minutes** | 500/mes | 500/mes |
| **Bandwidth** | 100GB | 100GB |
| **PostgreSQL** | 1GB | 10GB |
| **Redis** | 25MB | 256MB |

### Cu√°ndo Hacer Upgrade

**Debes hacer upgrade si:**
- ‚úÖ Vas a producci√≥n real con usuarios
- ‚úÖ Necesitas servicio 24/7 sin dormido
- ‚úÖ Database > 1GB
- ‚úÖ Necesitas m√°s Redis para WebSockets

**Puedes quedarte en Free si:**
- ‚úÖ Est√°s en desarrollo/testing
- ‚úÖ Es un prototipo/demo
- ‚úÖ No importa el tiempo de arranque inicial

### C√≥mo Hacer Upgrade

1. Ve al servicio (backend o frontend)
2. Click en **"Settings"**
3. Scroll a **"Instance Type"**
4. Selecciona **"Starter"**
5. Click **"Save Changes"**

**Costo Total Recomendado para Producci√≥n:**
```
Backend Starter:    $7/mes
PostgreSQL Starter: $7/mes
Redis Starter:      $10/mes
Frontend:           $0 (gratis)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
TOTAL:              $24/mes
```

**Alternativa Econ√≥mica:**
```
Backend Starter:    $7/mes
PostgreSQL Free:    $0 (1GB suficiente para empezar)
Redis Free:         $0 (25MB suficiente para empezar)
Frontend:           $0
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
TOTAL:              $7/mes
```

---

## üîß MANTENIMIENTO

### Actualizar la Aplicaci√≥n

#### Deploy Autom√°tico (Recomendado)

Render.com hace auto-deploy en cada push a `main`:

```bash
# Hacer cambios en el c√≥digo
git add .
git commit -m "Update feature X"
git push origin main

# Render.com detecta el push y despliega autom√°ticamente
```

#### Deploy Manual

1. Ve al servicio en Render.com
2. Click **"Manual Deploy"**
3. Selecciona **"Deploy latest commit"**

### Ver Logs

```bash
# En Render.com Dashboard:
# 1. Selecciona el servicio
# 2. Click en "Logs"
# 3. Filtra por error/warning si es necesario
```

### Backup de Database

#### Autom√°tico (Solo planes pagados)
- Render.com hace backups autom√°ticos diarios

#### Manual (Free tier)

```bash
# 1. Ir a la database en Render.com
# 2. Click en "Connections"
# 3. Copiar "External Database URL"

# 4. En tu m√°quina local:
pg_dump "postgresql://user:pass@host:5432/db" > backup.sql

# 5. Para restaurar:
psql "postgresql://user:pass@host:5432/db" < backup.sql
```

### Monitorear Performance

#### M√©tricas en Render.com:
- CPU Usage
- Memory Usage
- Response Time
- Error Rate

1. Ve al servicio
2. Click en **"Metrics"**
3. Revisa gr√°ficas

#### Alertas:
1. Settings ‚Üí Notifications
2. Configura email para alertas
3. Umbrales: CPU > 80%, Memory > 85%

### Rollback a Versi√≥n Anterior

Si un deploy causa problemas:

1. Ve al servicio
2. Click en **"Events"**
3. Encuentra el deploy anterior exitoso
4. Click **"Rollback to this deploy"**

---

## üéØ CHECKLIST FINAL DE DEPLOYMENT

### Pre-Deployment
- [ ] C√≥digo subido a GitHub
- [ ] `render.yaml` configurado
- [ ] `build.sh` con permisos de ejecuci√≥n
- [ ] `requirements.txt` actualizado
- [ ] `gunicorn_config.py` creado

### Deployment
- [ ] Cuenta Render.com creada
- [ ] Repositorio conectado
- [ ] Blueprint aplicado (render.yaml)
- [ ] Servicios creados (backend, frontend, db, redis)
- [ ] Variables de entorno configuradas

### Post-Deployment
- [ ] Backend health check ‚úÖ
- [ ] Frontend carga correctamente ‚úÖ
- [ ] Login funciona ‚úÖ
- [ ] API calls funcionan (sin CORS errors) ‚úÖ
- [ ] WebSockets conectan ‚úÖ
- [ ] Database tiene datos de prueba ‚úÖ

### Configuraci√≥n Final
- [ ] `CORS_ALLOWED_ORIGINS` actualizado con URL frontend
- [ ] `VITE_API_URL` apunta a backend
- [ ] `VITE_WS_URL` apunta a backend WebSocket
- [ ] Auto-deploy activado
- [ ] Notificaciones configuradas

---

## üìö RECURSOS ADICIONALES

### Documentaci√≥n Oficial
- [Render.com Docs](https://render.com/docs)
- [Django Deployment](https://docs.djangoproject.com/en/5.0/howto/deployment/)
- [Vite Production Build](https://vitejs.dev/guide/build.html)

### Soporte
- [Render.com Community](https://community.render.com/)
- [Render.com Status](https://status.render.com/)

### Contacto del Proyecto
- GitHub: [Tu repositorio]
- Email: [Tu email]

---

## ‚úÖ ¬°DEPLOYMENT EXITOSO!

Si llegaste hasta aqu√≠ y todos los checks pasaron, tu **Sistema de Gesti√≥n Ecuestre FEI** est√° funcionando en producci√≥n.

**URLs de tu aplicaci√≥n:**
- üåê **Frontend:** `https://equestrian-frontend.onrender.com`
- üîå **Backend API:** `https://equestrian-backend.onrender.com`
- üè• **Health Check:** `https://equestrian-backend.onrender.com/api/health/`

**Usuarios de prueba:**
- üëë **Admin:** `admin` / `admin123`
- üèÜ **Organizador:** `organizer1` / `org123`
- ‚öñÔ∏è **Juez:** `judge1` / `judge123`

**Pr√≥ximos pasos:**
1. Cambiar contrase√±as de usuarios de prueba
2. Crear usuarios reales
3. Configurar dominio personalizado (opcional)
4. Considerar upgrade a plan Starter para producci√≥n real

---

**¬°Felicitaciones! üéâ**

Tu sistema ecuestre FEI est√° desplegado y listo para competencias internacionales.
